<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="Fallcoin&#39;s Blog">
<meta property="og:url" content="https://fallcoin.github.io/index.html">
<meta property="og:site_name" content="Fallcoin&#39;s Blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Fallcoin">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://fallcoin.github.io/"/>





  <title>Fallcoin's Blog</title>
  








<meta name="generator" content="Hexo 5.4.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Fallcoin's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://fallcoin.github.io/2021/08/10/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fallcoin's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/08/10/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/" itemprop="url">函数式编程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-08-10T22:05:55+08:00">
                2021-08-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="函数式编程"><a href="#函数式编程" class="headerlink" title="函数式编程"></a>函数式编程</h2><h3 id="函数式编程概念"><a href="#函数式编程概念" class="headerlink" title="函数式编程概念"></a>函数式编程概念</h3><p>函数式编程是一种编程范式</p>
<p>举个例子，输出a + b的结果</p>
<p>面向过程</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = <span class="number">1</span>, b = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">let</span> r = a + b;</span><br><span class="line"><span class="built_in">console</span>.log(r);</span><br></pre></td></tr></table></figure>

<p>面向对象</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Calculator</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="title">add</span>(<span class="params">a, b</span>)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> a + b;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="title">log</span>(<span class="params">r</span>)</span> &#123;</span><br><span class="line">		<span class="built_in">console</span>.log(r);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> c = <span class="keyword">new</span> Calculator;</span><br><span class="line"><span class="keyword">const</span> r = c.add(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">c.log(r);</span><br></pre></td></tr></table></figure>

<p>函数式编程</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(add(<span class="number">1</span>, <span class="number">2</span>));</span><br></pre></td></tr></table></figure>

<p>再函数式编程中，函数是头等公民，这也就意味着：</p>
<ul>
<li>函数可以赋值给变量</li>
<li>函数可以作为参数</li>
<li>函数可以作为返回值</li>
</ul>
<h3 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h3><h4 id="闭包"><a href="#闭包" class="headerlink" title="闭包"></a>闭包</h4><p>首先，<code>JavaScript</code>是词法作用域，也就是说其函数的作用域在定义时便决定了，而动态作用域则是由运行情况决定。举个例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> value = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(value);	<span class="comment">//	1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bar</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> value = <span class="number">2</span>;</span><br><span class="line">    foo();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bar();</span><br></pre></td></tr></table></figure>

<p>上述代码的输出为<strong>1</strong>，而不是2，因为foo函数里的value引用的是定义时的全局作用域下的1，如果是动态作用域则会引用bar作用域中的2。</p>
<p>而闭包简单来说就是在一个内层函数中访问到其外层函数的作用域，举个例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">a</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">let</span> name = <span class="string">&#x27;zs&#x27;</span></span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(name);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述代码就是一个闭包，a函数返回一个匿名函数，而匿名函数里又引用了a函数作用域里的name属性。一般函数在执行时会压入执行栈，结束后就会被弹出，所申请的空间和变量等就会被释放。但由于name属性被另一个函数所引用，所以a函数作用域的name属性会不被释放。</p>
<p>所以闭包是一个危险的操作，如果未能及时释放会造成内存泄漏。</p>
<h4 id="纯函数"><a href="#纯函数" class="headerlink" title="纯函数"></a>纯函数</h4><p>什么是纯函数？</p>
<ul>
<li>函数的返回结果只依赖于它的参数，相同的输入始终得到相同的输出</li>
<li>函数的执行过程里没有副作用（副作用：该函数执行时是否产生了外部可观察的变化）</li>
</ul>
<p>优点</p>
<ul>
<li><p>可缓存</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如lodash中的memorize函数</span></span><br><span class="line"><span class="keyword">const</span> resolver = <span class="function">(<span class="params">...args</span>) =&gt;</span> <span class="built_in">JSON</span>.stringify(args);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">memorize</span>(<span class="params">fn, resolver</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> cache = &#123;&#125;;	<span class="comment">// 存放参数和结果的对应关系</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> key = resolver(...args);</span><br><span class="line">        <span class="keyword">if</span> (cache[key]) &#123;</span><br><span class="line">            <span class="keyword">return</span> cache[key];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            cache[key] = fn(...args);</span><br><span class="line">            <span class="keyword">return</span> cache[key];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>可测试</p>
<p>因为不依赖外部变量，所以可以预期输出</p>
</li>
</ul>
<h4 id="柯里化"><a href="#柯里化" class="headerlink" title="柯里化"></a>柯里化</h4><p>柯里化函数可以累计参数，只有当提供的参数满足时才会返回结果否则返回一个函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">1</span>)(<span class="number">2</span>)(<span class="number">3</span>);</span><br><span class="line">add(<span class="number">1</span>, <span class="number">2</span>)(<span class="number">3</span>);</span><br><span class="line">add(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line">add(<span class="number">1</span>)(<span class="number">2</span>, <span class="number">3</span>);</span><br></pre></td></tr></table></figure>

<p>原理：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">curry</span>(<span class="params">fn</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> argsLength = fn.length;</span><br><span class="line">    <span class="keyword">const</span> curried = <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (args.length &lt; argsLength) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="function">(<span class="params">...rest</span>) =&gt;</span> curried(...args, ...rest);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> fn(...args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> curried;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="组合"><a href="#组合" class="headerlink" title="组合"></a>组合</h4><p>在<code>loadash</code>中，有<code>flow</code>函数和<code>flowRight</code>函数。</p>
<p><code>flow</code>创建一个函数，每一个连续调用，传入的参数都是前一个函数返回的结果。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flow</span>(<span class="params">...fns</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (fns.length === <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> fns[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fns.reduceRight(<span class="function">(<span class="params">a, b</span>) =&gt;</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> a(b(...args)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>flowRight</code>类似<code>flow</code>，只是它调用函数的顺序是从右往左，它是redux的compose的实现原理。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flowRight</span>(<span class="params">...fns</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (fns.length === <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> fns[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fns.reduce(<span class="function">(<span class="params">a, b</span>) =&gt;</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> a(b(...args)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Pointfree"><a href="#Pointfree" class="headerlink" title="Pointfree"></a>Pointfree</h3><p>把数据处理的过程先定义成一种与参数无关的合成运算就叫PointFree。</p>
<h3 id="函子"><a href="#函子" class="headerlink" title="函子"></a>函子</h3><ul>
<li>可以用来管理值和值的变化过程</li>
<li>把异常和异步操作等副作用控制在可控的范围之内</li>
</ul>
<h4 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h4><ul>
<li>如果一个对象内部持有一个值那么就可以称之为容器</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Container</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="title">constructor</span>(<span class="params">value</span>)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.value = value;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Pointed-Container"><a href="#Pointed-Container" class="headerlink" title="Pointed Container"></a>Pointed Container</h4><ul>
<li>容器里面有of方法，则称之为Pointed Container</li>
<li>函数式编程在使用过程中尽可能不要用new创建对象</li>
<li>以此代替，写一个类似静态工厂方法的of方法来生产实例</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PointedContainer</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="title">constructor</span>(<span class="params">value</span>)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.value = value;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="title">of</span>(<span class="params">value</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PointedContainer(value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Functor"><a href="#Functor" class="headerlink" title="Functor"></a>Functor</h4><ul>
<li>含有map方法的Pointed Container可称为Functor（函子）</li>
<li>提供map方法，接入各种运算函数，进行值的映射</li>
<li>返回值还是functor</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Functor</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="title">constructor</span>(<span class="params">value</span>)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.value = value;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="title">of</span>(<span class="params">value</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Functor(value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">map</span>(<span class="params">fn</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Functor(fn(<span class="built_in">this</span>.value));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Monad"><a href="#Monad" class="headerlink" title="Monad"></a>Monad</h4><ul>
<li>函子的值也可以是函子，Monad（单子）是为了避免多层函子嵌套的情况</li>
<li>Monad为不可分割的实体，总是返回一个单层的函子</li>
<li>它有一个flatMap方法，与map方法作用类似，唯一区别是如果生成了一个嵌套函子会取出后者内部的值，保证返回的永远是一个单层的容器，不会出现嵌套的情况</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Monad</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="title">constructor</span>(<span class="params">value</span>)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.value = value;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="title">of</span>(<span class="params">value</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Monad(value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">map</span>(<span class="params">fn</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Monad(fn(<span class="built_in">this</span>.value));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">join</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">flatMap</span>(<span class="params">fn</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.map(fn).join();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="IO函子与副作用"><a href="#IO函子与副作用" class="headerlink" title="IO函子与副作用"></a>IO函子与副作用</h4><ul>
<li>副作用是指函数在正常工作任务之外对外部环境所施加的影响</li>
<li>由于外部环境不可控，包含副作用的逻辑往往不能预测</li>
<li>函数式编程提倡把副作用分离出来，让没有副作用的纯逻辑放在一起</li>
<li>由于函数本身是纯的，但函数的执行不是纯的，因此IO函子通过推迟执行的方式来实现对副作用的管理和隔离</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IO</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">value</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="title">of</span>(<span class="params">value</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> IO(value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">map</span>(<span class="params">fn</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> IO(compose(fn, <span class="built_in">this</span>.value));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">flatMap</span>(<span class="params">fn</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> IO(compose(<span class="function"><span class="params">x</span> =&gt;</span> x.value(), fn, <span class="built_in">this</span>.value));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">start</span>(<span class="params">callback</span>)</span> &#123;</span><br><span class="line">        callback(<span class="built_in">this</span>.value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Task函子"><a href="#Task函子" class="headerlink" title="Task函子"></a>Task函子</h4><ul>
<li>Task函子通过类似Promise的resolve的风格来声明一个异步流程</li>
<li>Promise的任务是立刻执行，而Task是在调用的时候才开始执行，是惰性执行的</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://fallcoin.github.io/2021/07/29/%E5%9F%BA%E4%BA%8EVue%E5%AE%9E%E7%8E%B0%E5%A4%A7%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%92%8C%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fallcoin's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/07/29/%E5%9F%BA%E4%BA%8EVue%E5%AE%9E%E7%8E%B0%E5%A4%A7%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%92%8C%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0/" itemprop="url">基于Vue实现大文件上传和断点续传</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-07-29T23:10:45+08:00">
                2021-07-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="基于Vue实现大文件上传和断点续传"><a href="#基于Vue实现大文件上传和断点续传" class="headerlink" title="基于Vue实现大文件上传和断点续传"></a>基于Vue实现大文件上传和断点续传</h2><p>文件上传一般有两种方式</p>
<ol>
<li>基于文件流（form-data）</li>
<li>客户端把文件转为Base64格式后传输</li>
</ol>
<h3 id="基于文件流的方式"><a href="#基于文件流的方式" class="headerlink" title="基于文件流的方式"></a>基于文件流的方式</h3><p>前端代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;el-upload</span><br><span class="line">        class=&quot;upload-demo&quot;</span><br><span class="line">        drag</span><br><span class="line">        action=&quot;http://127.0.0.1:3300/api/upload1&quot;</span><br><span class="line">        :show-file-list=&quot;false&quot;</span><br><span class="line">        :on-success=&quot;handleSuccess&quot;</span><br><span class="line">        :before-upload=&quot;beforeUpload&quot;</span><br><span class="line">    &gt;</span><br><span class="line">        &lt;i class=&quot;el-icon-upload&quot;&gt;&lt;/i&gt;</span><br><span class="line">        &lt;div class=&quot;el-upload__text&quot;&gt;将文件拖到此处，或&lt;em&gt;点击上传&lt;/em&gt;&lt;/div&gt;</span><br><span class="line">        &lt;template #tip&gt;</span><br><span class="line">            &lt;div class=&quot;el-upload__tip&quot;&gt;</span><br><span class="line">                只能上传 jpg/png 文件，且不超过 500kb</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/template&gt;</span><br><span class="line">    &lt;/el-upload&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import &#123; defineComponent &#125; from &quot;vue&quot;;</span><br><span class="line">import &#123; ElMessage &#125; from &quot;element-plus&quot;;</span><br><span class="line"></span><br><span class="line">export default defineComponent(&#123;</span><br><span class="line">    name: &quot;App&quot;,</span><br><span class="line">    setup() &#123;</span><br><span class="line">        function handleSuccess(result) &#123;</span><br><span class="line">            if (result.status === 200) &#123;</span><br><span class="line">                ElMessage.success(&quot;上传成功&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        function beforeUpload(file) &#123;</span><br><span class="line">            // 格式校验</span><br><span class="line">            const &#123; type, size &#125; = file;</span><br><span class="line">            if (!/(png|gif|jpeg|jpg)/i.test(type)) &#123;</span><br><span class="line">                ElMessage.error(&quot;文件格式错误&quot;);</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">            if (size &gt; 200 * 1024 * 1024) &#123;</span><br><span class="line">                ElMessage.error(&quot;文件大小错误&quot;);</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return &#123;</span><br><span class="line">            beforeUpload,</span><br><span class="line">            handleSuccess,</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>后端代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> uploadByFormData = <span class="function"><span class="keyword">function</span> (<span class="params">file</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 创建可读流</span></span><br><span class="line">        <span class="keyword">const</span> reader = fs.createReadStream(file.path);</span><br><span class="line">        <span class="keyword">let</span> filePath = BASE_PATH + <span class="string">`<span class="subst">$&#123;file.name&#125;</span>`</span>;</span><br><span class="line">        <span class="comment">// 创建可写流</span></span><br><span class="line">        <span class="keyword">const</span> upStream = fs.createWriteStream(filePath);</span><br><span class="line">        <span class="comment">// 可读流通过管道写入可写流</span></span><br><span class="line">        reader.pipe(upStream);</span><br><span class="line">        upStream.on(<span class="string">&#x27;finish&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            resolve(&#123;</span><br><span class="line">                <span class="attr">msg</span>: <span class="string">&#x27;upload success&#x27;</span></span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="通过转化Base64的格式"><a href="#通过转化Base64的格式" class="headerlink" title="通过转化Base64的格式"></a>通过转化Base64的格式</h3><ul>
<li><p>先将上传的文件先进行解析（FileReader），然后将其转化为base64，最后传到服务器</p>
</li>
<li><p>为了保证正确性，需要对传输内容使用<code>encodeURIComponent</code>进行编码</p>
</li>
</ul>
<p>前端代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;el-upload</span><br><span class="line">        class=&quot;upload-demo&quot;</span><br><span class="line">        drag</span><br><span class="line">        action</span><br><span class="line">        :auto-upload=&quot;false&quot;</span><br><span class="line">        :show-file-list=&quot;false&quot;</span><br><span class="line">        :on-change=&quot;changeFile&quot;</span><br><span class="line">    &gt;</span><br><span class="line">        &lt;i class=&quot;el-icon-upload&quot;&gt;&lt;/i&gt;</span><br><span class="line">        &lt;div class=&quot;el-upload__text&quot;&gt;将文件拖到此处，或&lt;em&gt;点击上传&lt;/em&gt;&lt;/div&gt;</span><br><span class="line">        &lt;template #tip&gt;</span><br><span class="line">            &lt;div class=&quot;el-upload__tip&quot;&gt;</span><br><span class="line">                只能上传 jpg/png 文件，且不超过 500kb</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/template&gt;</span><br><span class="line">    &lt;/el-upload&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import &#123; defineComponent &#125; from &quot;vue&quot;;</span><br><span class="line">import &#123; ElMessage &#125; from &quot;element-plus&quot;;</span><br><span class="line">import axios from &quot;axios&quot;;</span><br><span class="line">import qs from &quot;qs&quot;;</span><br><span class="line"></span><br><span class="line">export default defineComponent(&#123;</span><br><span class="line">    name: &quot;App&quot;,</span><br><span class="line">    setup() &#123;</span><br><span class="line">        async function changeFile(file) &#123;</span><br><span class="line">            if (!file) &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            file = file.raw;</span><br><span class="line">            const result = await fileParse(file);</span><br><span class="line">            const res = await axios.post(</span><br><span class="line">                &quot;/api/upload2&quot;,</span><br><span class="line">                qs.stringify(&#123;</span><br><span class="line">                    chunk: encodeURIComponent(result),</span><br><span class="line">                    filename: file.name,</span><br><span class="line">                &#125;),</span><br><span class="line">                &#123;</span><br><span class="line">                    headers: &#123;</span><br><span class="line">                        &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;,</span><br><span class="line">                    &#125;,</span><br><span class="line">                &#125;</span><br><span class="line">            );</span><br><span class="line">            if (res.status === 200) &#123;</span><br><span class="line">                ElMessage.success(&quot;上传成功&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        function fileParse(file) &#123;</span><br><span class="line">            return new Promise((resolve) =&gt; &#123;</span><br><span class="line">                const fileReader = new FileReader();</span><br><span class="line">                fileReader.readAsDataURL(file);</span><br><span class="line">                fileReader.onload = (ev) =&gt; resolve(ev.target?.result);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        return &#123;</span><br><span class="line">            changeFile,</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>后端代码：</p>
<ul>
<li>由于base64格式会有固定前缀，所以需要去掉。</li>
<li><code>SparkMD5</code>为处理文件的一个库</li>
<li><code>spark.end()</code>可以生成该文件的hash值，只要文件内容不变，hash值就不会变</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> uploadByBase64 = <span class="function"><span class="keyword">function</span> (<span class="params">chunk, filename</span>) </span>&#123;</span><br><span class="line">    chunk = <span class="built_in">decodeURIComponent</span>(chunk);</span><br><span class="line">    chunk = chunk.replace(<span class="regexp">/^data:image\/w+;base64,/</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">    chunk = Buffer.from(chunk, <span class="string">&#x27;base64&#x27;</span>);</span><br><span class="line">    <span class="keyword">let</span> spark = <span class="keyword">new</span> SparkMD5.ArrayBuffer(),</span><br><span class="line">        suffix = <span class="regexp">/\.([0-9a-zA-Z]+)$/</span>.exec(filename)[<span class="number">1</span>],</span><br><span class="line">        path;</span><br><span class="line">    spark.append(chunk);</span><br><span class="line">    path = <span class="string">`<span class="subst">$&#123;BASE_PATH&#125;</span>/<span class="subst">$&#123;spark.end()&#125;</span>.<span class="subst">$&#123;suffix&#125;</span>`</span>;</span><br><span class="line">    fs.writeFileSync(path, chunk);</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">msg</span>: <span class="string">&#x27;upload success&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="断点续传"><a href="#断点续传" class="headerlink" title="断点续传"></a>断点续传</h3><p>实现思路：</p>
<ul>
<li>将文件切成100等分</li>
<li>将这100等分封装成函数，每个函数返回promise</li>
<li>将这100个请求串行发送，后端收到后再对文件进行合并</li>
<li>为每当有请求发送成功便将其从数组中剔除，当下一次继续时便可以将未发送的请求重新组装成数组并发送，实现断点续传</li>
<li>使用一个变量用来记录发送请求成功的个数，当到达100时便说明发送完了，给服务器发送合并的请求</li>
</ul>
<p>前端代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;el-upload</span><br><span class="line">        class=&quot;upload-demo&quot;</span><br><span class="line">        drag</span><br><span class="line">        action</span><br><span class="line">        :auto-upload=&quot;false&quot;</span><br><span class="line">        :show-file-list=&quot;false&quot;</span><br><span class="line">        :on-change=&quot;changeFile&quot;</span><br><span class="line">    &gt;</span><br><span class="line">        &lt;i class=&quot;el-icon-upload&quot;&gt;&lt;/i&gt;</span><br><span class="line">        &lt;div class=&quot;el-upload__text&quot;&gt;将文件拖到此处，或&lt;em&gt;点击上传&lt;/em&gt;&lt;/div&gt;</span><br><span class="line">        &lt;template #tip&gt;</span><br><span class="line">            &lt;div class=&quot;el-upload__tip&quot;&gt;</span><br><span class="line">                只能上传 jpg/png 文件，且不超过 500kb</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/template&gt;</span><br><span class="line">    &lt;/el-upload&gt;</span><br><span class="line">    &lt;br /&gt;</span><br><span class="line">    &lt;div class=&quot;progress&quot;&gt;</span><br><span class="line">        &lt;el-progress</span><br><span class="line">            :text-inside=&quot;true&quot;</span><br><span class="line">            :stroke-width=&quot;24&quot;</span><br><span class="line">            :percentage=&quot;total&quot;</span><br><span class="line">            status=&quot;success&quot;</span><br><span class="line">        &gt;&lt;/el-progress&gt;</span><br><span class="line">        &lt;el-button</span><br><span class="line">            :type=&quot;abort ? &#x27;success&#x27; : &#x27;danger&#x27;&quot;</span><br><span class="line">            v-if=&quot;total === 100 || total === 0 ? false : true&quot;</span><br><span class="line">            @click=&quot;handleBtn&quot;</span><br><span class="line">            &gt;&#123;&#123; abort ? &quot;继续&quot; : &quot;暂停&quot; &#125;&#125;&lt;/el-button</span><br><span class="line">        &gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;div&gt;&lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import &#123; defineComponent, reactive, toRefs &#125; from &quot;vue&quot;;</span><br><span class="line">import &#123; ElMessage &#125; from &quot;element-plus&quot;;</span><br><span class="line">import axios from &quot;axios&quot;;</span><br><span class="line">import SparkMD5 from &quot;spark-md5&quot;;</span><br><span class="line"></span><br><span class="line">export default defineComponent(&#123;</span><br><span class="line">    name: &quot;App&quot;,</span><br><span class="line">    setup() &#123;</span><br><span class="line">        const state = reactive(&#123;</span><br><span class="line">            total: 0,</span><br><span class="line">            abort: false,</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        let fileData = &#123;</span><br><span class="line">            partList: [],</span><br><span class="line">            hash: null,</span><br><span class="line">        &#125;;</span><br><span class="line">        async function changeFile(file) &#123;</span><br><span class="line">            if (!file) &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            file = file.raw;</span><br><span class="line">            let buffer = await fileParse(file),</span><br><span class="line">                spark = new SparkMD5.ArrayBuffer(),</span><br><span class="line">                hash,</span><br><span class="line">                suffix;</span><br><span class="line">            spark.append(buffer);</span><br><span class="line">            hash = spark.end();</span><br><span class="line">            suffix = /\.([0-9a-zA-Z]+)$/i.exec(file.name)[1];</span><br><span class="line">            let partSize = file.size / 100,</span><br><span class="line">                cur = 0;</span><br><span class="line">            for (let i = 0; i &lt; 100; i++) &#123;</span><br><span class="line">                let item = &#123;</span><br><span class="line">                    chunk: file.slice(cur, cur + partSize),</span><br><span class="line">                    filename: `$&#123;hash&#125;_$&#123;i&#125;.$&#123;suffix&#125;`,</span><br><span class="line">                &#125;;</span><br><span class="line">                cur += partSize;</span><br><span class="line">                fileData.partList.push(item);</span><br><span class="line">            &#125;</span><br><span class="line">            fileData.hash = hash;</span><br><span class="line">            sendRequest();</span><br><span class="line">        &#125;</span><br><span class="line">        function sendRequest() &#123;</span><br><span class="line">            let requestList = [];</span><br><span class="line">            fileData.partList.forEach((item, index) =&gt; &#123;</span><br><span class="line">                let fn = async () =&gt; &#123;</span><br><span class="line">                    let formData = new FormData();</span><br><span class="line">                    formData.append(&quot;chunk&quot;, item.chunk);</span><br><span class="line">                    formData.append(&quot;filename&quot;, item.filename);</span><br><span class="line">                    const result = await axios.post(&quot;/api/upload3&quot;, formData, &#123;</span><br><span class="line">                        headers: &#123; &quot;Content-Type&quot;: &quot;multipart/form-data&quot; &#125;,</span><br><span class="line">                    &#125;);</span><br><span class="line">                    if (result.status === 200) &#123;</span><br><span class="line">                        state.total += 1;</span><br><span class="line">                        fileData.partList.splice(index, 1);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line">                requestList.push(fn);</span><br><span class="line">            &#125;);</span><br><span class="line">            let i = 0;</span><br><span class="line">            let complete = async () =&gt; &#123;</span><br><span class="line">                let result = await axios.get(&quot;/api/merge&quot;, &#123;</span><br><span class="line">                    params: &#123;</span><br><span class="line">                        hash: fileData.hash,</span><br><span class="line">                    &#125;,</span><br><span class="line">                &#125;);</span><br><span class="line">                fileData = &#123;</span><br><span class="line">                    partList: [],</span><br><span class="line">                    hash: null,</span><br><span class="line">                &#125;;</span><br><span class="line">                if (result.status === 200) &#123;</span><br><span class="line">                    ElMessage.success(&quot;upload success&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            let send = async () =&gt; &#123;</span><br><span class="line">                if (state.abort) &#123;</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">                if (i &gt;= requestList.length) &#123;</span><br><span class="line">                    complete();</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">                await requestList[i]();</span><br><span class="line">                i++;</span><br><span class="line">                send();</span><br><span class="line">            &#125;;</span><br><span class="line">            send();</span><br><span class="line">        &#125;</span><br><span class="line">        function fileParse(file) &#123;</span><br><span class="line">            return new Promise((resolve) =&gt; &#123;</span><br><span class="line">                const fileReader = new FileReader();</span><br><span class="line">                fileReader.readAsArrayBuffer(file);</span><br><span class="line">                fileReader.onload = (ev) =&gt; resolve(ev.target?.result);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        function handleBtn() &#123;</span><br><span class="line">            if (state.abort) &#123;</span><br><span class="line">                // 暂停中</span><br><span class="line">                state.abort = false;</span><br><span class="line">                sendRequest();</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                state.abort = true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return &#123;</span><br><span class="line">            changeFile,</span><br><span class="line">            ...toRefs(state),</span><br><span class="line">            handleBtn,</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line">.progress &#123;</span><br><span class="line">    width: 400px;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>后端代码：</p>
<ul>
<li>后端创建一个临时文件夹，用于存放切片</li>
<li>后端每次收到切片后进行判断是否存在，如果不存在则写入</li>
<li>当收到merge请求后将切片文件排序后合并成一个文件，最后删除临时文件夹</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> uploadBySlice = <span class="function"><span class="keyword">function</span> (<span class="params">chunk, filename</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> hash = <span class="regexp">/([0-9a-zA-Z]+)_\d+/</span>.exec(filename)[<span class="number">1</span>],</span><br><span class="line">            path = <span class="string">`<span class="subst">$&#123;BASE_PATH&#125;</span>/<span class="subst">$&#123;hash&#125;</span>`</span>;</span><br><span class="line">        !fs.existsSync(path) ? fs.mkdirSync(path) : <span class="literal">null</span>;</span><br><span class="line">        path = <span class="string">`<span class="subst">$&#123;path&#125;</span>/<span class="subst">$&#123;filename&#125;</span>`</span>;</span><br><span class="line">        fs.access(path, <span class="keyword">async</span> err =&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (!err) &#123;</span><br><span class="line">                resolve(&#123;</span><br><span class="line">                    <span class="attr">code</span>: <span class="number">200</span>,</span><br><span class="line">                    <span class="attr">path</span>: path.replace(__dirname, <span class="string">`http://127.0.0.1:3300`</span>)</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">let</span> readStream = fs.createReadStream(chunk.path),</span><br><span class="line">                writeStream = fs.createWriteStream(path);</span><br><span class="line">            readStream.pipe(writeStream);</span><br><span class="line">            readStream.on(<span class="string">&#x27;end&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                fs.unlinkSync(chunk.path);</span><br><span class="line">                resolve(&#123;</span><br><span class="line">                    <span class="attr">path</span>: path.replace(__dirname, <span class="string">`http://127.0.0.1:3300`</span>)</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> merge = <span class="function"><span class="keyword">function</span> (<span class="params">hash</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> path = <span class="string">`<span class="subst">$&#123;BASE_PATH&#125;</span>/<span class="subst">$&#123;hash&#125;</span>`</span>,</span><br><span class="line">        fileList = fs.readdirSync(path),</span><br><span class="line">        suffix;</span><br><span class="line">    fileList.sort(<span class="function">(<span class="params">a, b</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> reg = <span class="regexp">/_(\d+)/</span>;</span><br><span class="line">        <span class="keyword">return</span> reg.exec(a)[<span class="number">1</span>] - reg.exec(b)[<span class="number">1</span>];</span><br><span class="line">    &#125;).forEach(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">        !suffix ? suffix = <span class="regexp">/\.([0-9a-zA-Z]+)$/</span>.exec(item)[<span class="number">1</span>] : <span class="literal">null</span>;</span><br><span class="line">        fs.appendFileSync(<span class="string">`<span class="subst">$&#123;BASE_PATH&#125;</span>/<span class="subst">$&#123;hash&#125;</span>.<span class="subst">$&#123;suffix&#125;</span>`</span>, fs.readFileSync(<span class="string">`<span class="subst">$&#123;path&#125;</span>/<span class="subst">$&#123;item&#125;</span>`</span>));</span><br><span class="line">        fs.unlinkSync(<span class="string">`<span class="subst">$&#123;path&#125;</span>/<span class="subst">$&#123;item&#125;</span>`</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">    fs.rmdirSync(path);</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">`http://127.0.0.1:3300/upload/<span class="subst">$&#123;hash&#125;</span>.<span class="subst">$&#123;suffix&#125;</span>`</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://fallcoin.github.io/2021/07/25/%E4%BD%BF%E7%94%A8canvas%E7%94%BB%E5%87%BA%E6%98%9F%E7%A9%BA%E5%9B%BE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fallcoin's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/07/25/%E4%BD%BF%E7%94%A8canvas%E7%94%BB%E5%87%BA%E6%98%9F%E7%A9%BA%E5%9B%BE/" itemprop="url">使用canvas画出星空图</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-07-25T21:41:58+08:00">
                2021-07-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="如何使用Canvas绘制一个星空图"><a href="#如何使用Canvas绘制一个星空图" class="headerlink" title="如何使用Canvas绘制一个星空图"></a>如何使用Canvas绘制一个星空图</h2><h3 id="分析需求"><a href="#分析需求" class="headerlink" title="分析需求"></a>分析需求</h3><p>要实现的效果如图：</p>
<p><img src="https://fallcoin.github.io/images/1.gif"></p>
<p>从图中我们可以分析出：</p>
<ol>
<li>需要一个画布作为背景，且上面有许多圆点，所以可以抽象出两个类，第一个是用来描述整个效果的类，另一个是圆点类</li>
<li>圆点的位置不同，大小，不同，运动的速度和方向也不同，但是圆点始终在屏幕中，且在运动到边缘时会反弹</li>
<li>同时相近的圆点之间有连线，鼠标与相近的点也有连线</li>
</ol>
<h3 id="实现步骤"><a href="#实现步骤" class="headerlink" title="实现步骤"></a>实现步骤</h3><h4 id="先绘制背景图及样式"><a href="#先绘制背景图及样式" class="headerlink" title="先绘制背景图及样式"></a>先绘制背景图及样式</h4><p>首先需要一个<code>canvas</code>标签：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">canvas</span> <span class="attr">id</span>=<span class="string">&quot;canvas&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>css样式（为了更突出使用黑色）：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">* &#123;</span><br><span class="line">    <span class="comment">/* 使内容撑满 */</span></span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">overflow</span>: hidden;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">html</span>, <span class="selector-tag">body</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">background-color</span>: <span class="number">#000</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#canvas</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: relative;</span><br><span class="line">    <span class="attribute">z-index</span>: <span class="number">10</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="设置画布和点"><a href="#设置画布和点" class="headerlink" title="设置画布和点"></a>设置画布和点</h4><p>我们创建一个类当作整个的星空活动，它需要有几个属性：画布对象，存储星星的数组，星星的配置属性</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Effect</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">option</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.canvas = option.canvas;</span><br><span class="line">        <span class="built_in">this</span>.ctx = <span class="built_in">this</span>.canvas.getContext(<span class="string">&#x27;2d&#x27;</span>);</span><br><span class="line">        <span class="built_in">this</span>.dots = [];	<span class="comment">// 存储星星</span></span><br><span class="line">        <span class="built_in">this</span>.config = &#123;</span><br><span class="line">            <span class="attr">r</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="attr">color</span>: <span class="string">&#x27;ragba(255, 255, 255, 0.8)&#x27;</span>,</span><br><span class="line">            <span class="attr">xv_range</span>: [-<span class="number">2</span>, <span class="number">2</span>],	<span class="comment">// x轴的速度范围</span></span><br><span class="line">            <span class="attr">yv_range</span>: [-<span class="number">2</span>, <span class="number">2</span>],	<span class="comment">// y轴的速度范围</span></span><br><span class="line">            <span class="attr">scale_range</span>: [<span class="number">0.5</span>, <span class="number">1.5</span>],	<span class="comment">// 缩放范围</span></span><br><span class="line">            <span class="attr">count</span>: <span class="number">150</span>，	<span class="comment">// 点的数量</span></span><br><span class="line">            <span class="attr">max_length</span>: <span class="number">100</span>	<span class="comment">// 两点之间连线的最大距离</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们还需要星星，它需要几个属性：坐标速度，颜色，半径及缩放比例。同时还需要提供一个draw方法使其画到画布上：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dot</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">option</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 粒子的属性为：坐标，速度，颜色，半径，缩放比例</span></span><br><span class="line">        <span class="built_in">this</span>.x = option.x;</span><br><span class="line">        <span class="built_in">this</span>.y = option.y;</span><br><span class="line">        <span class="built_in">this</span>.xv = option.xv;</span><br><span class="line">        <span class="built_in">this</span>.yv = option.yv;</span><br><span class="line">        <span class="built_in">this</span>.color = option.color;</span><br><span class="line">        <span class="built_in">this</span>.r = option.r;</span><br><span class="line">        <span class="built_in">this</span>.scale = option.scale;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">draw</span>(<span class="params">ctx</span>)</span> &#123;</span><br><span class="line">        ctx.beginPath();    <span class="comment">// 开始画</span></span><br><span class="line">        ctx.fillStyle = <span class="built_in">this</span>.color;     <span class="comment">// 背景颜色</span></span><br><span class="line">        ctx.strokeStyle = <span class="built_in">this</span>.color;   <span class="comment">// 边框颜色</span></span><br><span class="line">        <span class="comment">// 使用arc方法画圆，参数为（x坐标，y坐标，半径，起始角度，结束角度）</span></span><br><span class="line">        ctx.arc(<span class="built_in">this</span>.x, <span class="built_in">this</span>.y, <span class="built_in">this</span>.r * <span class="built_in">this</span>.scale, <span class="number">0</span>, <span class="built_in">Math</span>.PI * <span class="number">2</span>);</span><br><span class="line">        ctx.closePath();    <span class="comment">// 结束画</span></span><br><span class="line">        ctx.fill(); <span class="comment">// 填充</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="将点画到画布上"><a href="#将点画到画布上" class="headerlink" title="将点画到画布上"></a>将点画到画布上</h4><p>随后，我们需要定义整个星空活动的行为，为<code>Effect</code>类添加以下方法，并在其初始化时调用<code>init()</code>方法：</p>
<ol>
<li>设置画布大小</li>
<li>把点创建出来并存储在数组中</li>
<li>把上次的绘画内容清空，把点画出来</li>
</ol>
<p>由于点的大小，位置，速度都是随机的，因此我们创建一个辅助函数来生成随机数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">random</span>(<span class="params">min, max</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Math</span>.random() * (max - min) + min;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在创建点的时候有一点需要注意，点自身的面积是要全部出现在屏幕中的，也就是说点的x坐标最小不得小于点的半径，<strong>最大不得大于屏幕宽度 - 点的半径</strong>，y坐标同理。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">init</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setSize();</span><br><span class="line">    <span class="built_in">this</span>.drawDot(<span class="built_in">this</span>.config.count);</span><br><span class="line">    <span class="built_in">this</span>.draw();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">setSize</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 设置画布宽高</span></span><br><span class="line">    <span class="built_in">this</span>.canvas.width = <span class="built_in">window</span>.innerWidth;</span><br><span class="line">    <span class="built_in">this</span>.canvas.height = <span class="built_in">window</span>.innerHeight;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">drawDot</span>(<span class="params">count = <span class="number">100</span></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (count--) &#123;</span><br><span class="line">        <span class="keyword">const</span> dot = <span class="keyword">new</span> Dot(&#123;</span><br><span class="line">            <span class="attr">x</span>: random(<span class="built_in">this</span>.config.r, <span class="built_in">window</span>.innerWidth - <span class="built_in">this</span>.config.r),</span><br><span class="line">            <span class="attr">y</span>: random(<span class="built_in">this</span>.config.r, <span class="built_in">window</span>.innerHeight - <span class="built_in">this</span>.config.r),</span><br><span class="line">            <span class="attr">color</span>: <span class="built_in">this</span>.config.color,</span><br><span class="line">            <span class="attr">r</span>: <span class="built_in">this</span>.config.r,</span><br><span class="line">            <span class="attr">xv</span>: random(<span class="built_in">this</span>.config.xv_range[<span class="number">0</span>], <span class="built_in">this</span>.config.xv_range[<span class="number">1</span>]),</span><br><span class="line">            <span class="attr">yv</span>: random(<span class="built_in">this</span>.config.yv_range[<span class="number">0</span>], <span class="built_in">this</span>.config.yv_range[<span class="number">1</span>]),</span><br><span class="line">            <span class="attr">scale</span>: random(<span class="built_in">this</span>.config.scale_range[<span class="number">0</span>], <span class="built_in">this</span>.config.scale_range[<span class="number">1</span>])</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="built_in">this</span>.dots.push(dot);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">draw</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 把上次绘画内容清空</span></span><br><span class="line">    <span class="comment">// 2. 把创造的点画到画布上</span></span><br><span class="line">    <span class="built_in">this</span>.ctx.clearRect(<span class="number">0</span>, <span class="number">0</span>, <span class="built_in">window</span>.innerWidth, <span class="built_in">window</span>.innerHeight);</span><br><span class="line">    <span class="built_in">this</span>.dots.forEach(<span class="function"><span class="params">item</span> =&gt;</span> item.draw(<span class="built_in">this</span>.ctx));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="创建连线"><a href="#创建连线" class="headerlink" title="创建连线"></a>创建连线</h4><p>现在点已经出现在画布上了，我们需要为点创建连线。并不是每个点之间都有连线，而是两点之间的距离小于某个值才创建连线，且连线的透明度根据距离调整。</p>
<ol>
<li>两点间的距离可以通过勾股定理求得</li>
<li>透明度为<strong>1 - 两点间距离占最大距离的比例</strong></li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">draw</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1. 把上次绘画内容清空</span></span><br><span class="line"><span class="comment">     * 2. 把创造的点画到画布上</span></span><br><span class="line"><span class="comment">     * 3. 为点之间创建连线</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">this</span>.ctx.clearRect(<span class="number">0</span>, <span class="number">0</span>, <span class="built_in">window</span>.innerWidth, <span class="built_in">window</span>.innerHeight);</span><br><span class="line">    <span class="built_in">this</span>.dots.forEach(<span class="function"><span class="params">item</span> =&gt;</span> item.draw(<span class="built_in">this</span>.ctx));</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="built_in">this</span>.dots.length; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="number">0</span>; j &lt; <span class="built_in">this</span>.dots.length; j++) &#123;</span><br><span class="line">            <span class="keyword">const</span> distance = <span class="built_in">Math</span>.sqrt(<span class="built_in">Math</span>.pow(<span class="built_in">this</span>.dots[i].x - <span class="built_in">this</span>.dots[j].x, <span class="number">2</span>) + <span class="built_in">Math</span>.pow(<span class="built_in">this</span>.dots[i].y - <span class="built_in">this</span>.dots[j].y, <span class="number">2</span>));</span><br><span class="line">            <span class="keyword">if</span> (distance &lt; <span class="built_in">this</span>.config.max_length) &#123;</span><br><span class="line">                <span class="built_in">this</span>.ctx.strokeStyle = <span class="built_in">this</span>.config.color.replace(<span class="regexp">/, (\d\.*\d*)\)/</span>, <span class="function">(<span class="params">a, b</span>) =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">&#x27;,&#x27;</span> + b * (<span class="number">1</span> - distance / <span class="built_in">this</span>.config.max_length) + <span class="string">&#x27;)&#x27;</span>;</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="built_in">this</span>.ctx.beginPath();</span><br><span class="line">                <span class="built_in">this</span>.ctx.moveTo(<span class="built_in">this</span>.dots[i].x, <span class="built_in">this</span>.dots[i].y);</span><br><span class="line">                <span class="built_in">this</span>.ctx.lineTo(<span class="built_in">this</span>.dots[j].x, <span class="built_in">this</span>.dots[j].y);</span><br><span class="line">                <span class="built_in">this</span>.ctx.closePath();</span><br><span class="line">                <span class="built_in">this</span>.ctx.stroke();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="使点动起来"><a href="#使点动起来" class="headerlink" title="使点动起来"></a>使点动起来</h4><p>使用js实现动画，就是自己设置每一动画帧的状态。所以我们有几个选择，<code>setTimeout</code>，<code>setInterval</code>和<code>requestAnimatetionFrame</code>。这里我们使用<code>requestAnimatetionFrame</code>，因为使用定时器会有丢帧的问题。</p>
<p>为Effect类定义一个移动的方法，就是将下一帧显示的内容画出来：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">move</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.dots.forEach(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">        item.x += item.xv;</span><br><span class="line">        item.y += item.yv;</span><br><span class="line">        <span class="keyword">if</span> (item.x &lt; item.r || item.x &gt; <span class="built_in">window</span>.innerWidth - item.r) &#123;</span><br><span class="line">            item.xv *= -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (item.y &lt; item.r || item.y &gt; <span class="built_in">window</span>.innerHeight - item.r) &#123;</span><br><span class="line">            item.yv *= -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="built_in">this</span>.draw();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同时，为了实现动画在draw方法里使用<code>requestAnimatetionFrame</code>递归调用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.requestAnimationFrame(<span class="built_in">this</span>.move.bind(<span class="built_in">this</span>));</span><br></pre></td></tr></table></figure>

<h4 id="使点跟随鼠标位置"><a href="#使点跟随鼠标位置" class="headerlink" title="使点跟随鼠标位置"></a>使点跟随鼠标位置</h4><p>在Effect类中添加一个属性用来保存鼠标的位置：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.mouse = &#123;</span><br><span class="line">    <span class="attr">x</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">y</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义一个方法用来更新鼠标位置：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">mouseMove</span>(<span class="params">e</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.mouse.x = e.pageX;</span><br><span class="line">    <span class="built_in">this</span>.mouse.y = e.pageY;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>init()</code>方法里为画布监听<code>mousemove</code>方法进行鼠标的更新：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.canvas.addEventListener(<span class="string">&#x27;mousemove&#x27;</span>, <span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.mouse.x = e.pageX;</span><br><span class="line">    <span class="built_in">this</span>.mouse.y = e.pageY;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>为了使鼠标附近的点和鼠标连线，定义一个<code>drawMouseDot</code>方法,逻辑和点与点之间的连线一样：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">drawMouseDot</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="built_in">this</span>.dots.length; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> distance = <span class="built_in">Math</span>.sqrt(<span class="built_in">Math</span>.pow(<span class="built_in">this</span>.dots[i].x - <span class="built_in">this</span>.mouse.x, <span class="number">2</span>) + <span class="built_in">Math</span>.pow(<span class="built_in">this</span>.dots[i].y - <span class="built_in">this</span>.mouse.y, <span class="number">2</span>));</span><br><span class="line">        <span class="keyword">if</span> (distance &lt; <span class="built_in">this</span>.config.max_length) &#123;</span><br><span class="line">            <span class="built_in">this</span>.ctx.strokeStyle = <span class="built_in">this</span>.config.color.replace(<span class="regexp">/, (\d\.*\d*)\)/</span>, <span class="function">(<span class="params">a, b</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;,&#x27;</span> + b * (<span class="number">1</span> - distance / <span class="built_in">this</span>.config.max_length) + <span class="string">&#x27;)&#x27;</span>;</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="built_in">this</span>.ctx.beginPath();</span><br><span class="line">            <span class="built_in">this</span>.ctx.moveTo(<span class="built_in">this</span>.mouse.x, <span class="built_in">this</span>.mouse.y);</span><br><span class="line">            <span class="built_in">this</span>.ctx.lineTo(<span class="built_in">this</span>.dots[i].x, <span class="built_in">this</span>.dots[i].y);</span><br><span class="line">            <span class="built_in">this</span>.ctx.closePath();</span><br><span class="line">            <span class="built_in">this</span>.ctx.stroke();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后，在draw方法调用它就行了：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.drawMouseDot();</span><br></pre></td></tr></table></figure>


          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://fallcoin.github.io/2021/05/30/%E8%B0%88%E8%B0%88js%E4%B8%AD%E7%9A%84%E5%BC%82%E6%AD%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fallcoin's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/05/30/%E8%B0%88%E8%B0%88js%E4%B8%AD%E7%9A%84%E5%BC%82%E6%AD%A5/" itemprop="url">谈谈js中的异步</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-05-30T22:02:44+08:00">
                2021-05-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="进程和线程的认知"><a href="#进程和线程的认知" class="headerlink" title="进程和线程的认知"></a>进程和线程的认知</h2><p><strong>进程是什么？</strong></p>
<ul>
<li>进程是程序的<strong>一次执行</strong></li>
<li>进程是<strong>一个程序及其数据</strong>在处理机上顺序执行时所发生的活动。（<strong>进程并不是源程序</strong>）</li>
<li>进程是具有独立功能的程序在一个数据集合上运行的过程，它是系统进行<strong>资源分配和调度的基本单位</strong></li>
</ul>
<p>一个程序可能几十KB也有可能好几GB，而要执行一个程序，必须要将其加载到内存，可是要将一个大程序完全加载到内存是不切实际的，因此操作系统所做的只是将要执行的那一段加载到内存。如果允许过程中出现了缺页情况（需要执行的代码在外存），则进行程序中断，将需要的代码加载进内存（这里会有页面置换算法）。</p>
<p>在创建进程时操作系统会为其分配相应的数据结构。（PCB）</p>
<p><strong>操作系统是如何做到在单CPU的情况下同时允许多个进程的？</strong></p>
<p>在单CPU的电脑上，操作系统是如何做到边播放音乐边用QQ聊天的？其实这只是看起来操作系统在同时允许很多个进程，就像一段动画是由几百帧的静态画面组成的一样，操作系统内部也有对进程做处理，它让每个进程都有一个时间片获得CPU，当时间片到则切换下一个进程，我们看起来同时运行的结果只不过是时间片很小我们感觉不到而已。（这里涉及到操作系统的调度算法）</p>
<p><strong>死锁</strong></p>
<p>进程之间访问全局资源是互斥的，因此会发生死锁。</p>
<p>死锁产生的原因为这组死锁进程中的每一个进程，都在等待另一个死锁进程所占有的资源。</p>
<p>死锁的发生有几个必要条件：</p>
<ul>
<li><strong>互斥条件</strong>（一次只允许一个进程访问，你要是允许多个进程同时访问那哪来的死锁）</li>
<li><strong>请求和保持条件</strong>（一个进程本身占用资源并在请求其他资源）</li>
<li><strong>不可抢占条件</strong>（你要是可以抢占那抢了不就没有死锁问题了）</li>
<li><strong>循环等待条件</strong>（存在一个进程链，使得每个进程都占用下一个进程所需的至少一个资源，有点类似套娃）</li>
</ul>
<p><strong>线程是什么</strong></p>
<p>线程是一条执行路径，是程序执行时的最小单位，它是进程的一个执行流，是CPU调度和分派的基本单位，一个进程可以由很多个线程组成，线程间共享进程的所有资源，每个线程都有自己的堆栈和局部变量。</p>
<ul>
<li>一个线程只能属于一个进程，一个进程可以创建多个线程</li>
<li>线程的切换开销比进程的切换小</li>
<li>线程不能拥有资源，线程间共享进程的资源</li>
</ul>
<h2 id="JS单线程的应用"><a href="#JS单线程的应用" class="headerlink" title="JS单线程的应用"></a>JS单线程的应用</h2><p>我们都知道Javascript是一门单线程的语言，而单线程会带来几个问题。单线程意味着同一时间只能做一件事，如果有多个任务等待执行，那这些任务就需要进行排队，做完前一个任务才会去做后一个任务。</p>
<p>但是排队很多时候并不是由于CPU的运行效率，而是因为某些I/O操作，CPU需要等待I/O的结果再进行下一步的处理，所以这也就意味着很多时候CPU是闲着的。如果采用轮询的方法去判断一个任务是否完成，会导致效率太低，所以为了解决这个问题，采用的一个解决方法是异步处理。异步处理的解决方案是，我并不知道这个任务什么时候完成，有可能是1s后也有可能是10s，但不管是什么时候完成，完成后调用我传入的回调函数就行了。</p>
<p>可是如果把所有的逻辑都写在回调里面，会导致回调地狱的出现，使得代码的理解性和可维护性降低：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 例如：</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="number">3</span>);</span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="number">4</span>);</span><br><span class="line">            &#125;, <span class="number">4000</span>);</span><br><span class="line">        &#125;, <span class="number">3000</span>);</span><br><span class="line">    &#125;, <span class="number">2000</span>);</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>

<p>因此ES6提出了Promise，用于解决这个问题，通过then的链式调用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        resolve(<span class="number">1</span>)</span><br><span class="line">    &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;).then(<span class="function"><span class="params">val</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(val) <span class="comment">// 1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            resolve(<span class="number">2</span>)</span><br><span class="line">        &#125;, <span class="number">2000</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;).then(<span class="function"><span class="params">val</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(val) <span class="comment">// 2</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>Promise虽然解决了回调地狱的问题，但是可读性还是不太好，于是出现了<code>async/await</code>，使得异步代码看起来像同步代码一样</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 1. async/await虽然看起来像是同步代码块，但实际上还是异步的（里面是generator的语法糖，底层还是promise）</span></span><br><span class="line"><span class="comment"> * 2. await 只能在async函数里面使用</span></span><br><span class="line"><span class="comment"> * 3. await 后面接的函数必须返回一个pending状态的promise</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sleep</span>(<span class="params">wait</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            resolve(wait);</span><br><span class="line">        &#125;, wait);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> res;</span><br><span class="line">    res = <span class="keyword">await</span> sleep(<span class="number">1000</span>);    <span class="comment">// 1000</span></span><br><span class="line">    <span class="built_in">console</span>.log(res);</span><br><span class="line">    res = <span class="keyword">await</span> sleep(<span class="number">2000</span>);    <span class="comment">// 2000</span></span><br><span class="line">    <span class="built_in">console</span>.log(res);</span><br><span class="line">    <span class="keyword">return</span> res; <span class="comment">// 2000</span></span><br><span class="line">&#125;</span><br><span class="line">test()</span><br></pre></td></tr></table></figure>

<p>看起来<code>async/await</code>似乎完全可以替代Promise在业务中的使用，其实不然，使用<code>async/await</code>会导致捕获异常较为困难，只能在外面套一层<code>try/catch</code>进行捕获，而使用Promise可以在每个then节点后使用<code>catch</code>捕获 。</p>
<h2 id="Node单线程的优势"><a href="#Node单线程的优势" class="headerlink" title="Node单线程的优势"></a>Node单线程的优势</h2><p>首先我们先明确一点，node是单线程并不是单进程，现如今大多数CPU为多核，为了充分利用资源，node提供了<code>child_process</code>和<code>cluster</code>模块实现多进程的管理。</p>
<p>node在<strong>高并发</strong>的场景下拥有优势，因为它的工作模式是<strong>非阻塞IO模型</strong>，而java，apache这种是<strong>阻塞IO模型</strong>。</p>
<p><strong>什么是高并发？</strong></p>
<p>高并发是指在同一个时间点，大量用户访问同一API接口或url地址，在高并发场景下必须保证系统能够同时并行处理很多请求。</p>
<p>举个例子，就相当于开一家餐厅，高并发就相当于在一段时间内有很多人进来吃饭，为了运作正常需要为每个客人及时提供服务。</p>
<p><strong>如何解决？</strong></p>
<ul>
<li>增加机器数，负载均衡（开分店）</li>
<li>增加每台机器的CPU数量（雇佣更多的厨师）</li>
</ul>
<p><strong>后台任务</strong></p>
<p>后台任务一般分为两种：</p>
<ul>
<li>CPU任务：压缩、解压、加密、解密</li>
<li>I/O任务：文件操作、网络操作、数据库操作</li>
</ul>
<p>模拟成餐厅的话，CPU任务就相当于服务员任务，而I/O任务相当于厨师任务。</p>
<p><strong>阻塞I/O与非阻塞I/O</strong></p>
<p>阻塞I/O的工作模式是对于每一个请求，都开启一个线程处理，阻塞时进程分配的CPU资源在等待，当I/O操作结束再结束掉该线程。相当于每来一位顾客，就为他配一名服务员。但是这样有个缺点，在处理I/O请求的时候线程是阻塞的，CPU资源被占用，也就是服务员点完菜就坐那玩手机啥也不干了，等厨子做好了菜再叫服务员端上去。</p>
<p>而非阻塞I/O的工作模式为对每个请求都进行处理，以回调的方式进行通知。单线程只是针对于主线程，I/O操作底层是多线程调度。相当于只雇佣一名服务员，每接待一位顾客就通知后台的那些厨子，接待完再接待下一个。CPU始终在进行工作，提高了利用率。</p>
<p>因此<strong>阻塞I/O模型</strong>适用于<strong>CPU任务密集</strong>的场景，<strong>非阻塞I/O模型</strong>适用于<strong>I/O任务密集</strong>的场景。</p>
<h2 id="EventLoop"><a href="#EventLoop" class="headerlink" title="EventLoop"></a>EventLoop</h2><p>事件循环是计算机的一种运行机制，JavaScript语言采用的正是这种机制，而浏览器环境下的EventLoop和Node环境下的又有所区别。</p>
<p>在js中，异步任务分为两种，宏任务和微任务，它们分别存放在不同的队列里面。</p>
<ul>
<li>常见的宏任务有：script代码的加载，定时器，I/O操作，UI交互事件</li>
<li>常见的微任务有：Promise callbacks，process.nextTick，MutationObsever</li>
</ul>
<p>我们先来看一段代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">const</span> timer1 = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="number">3</span>);</span><br><span class="line">        resolve()</span><br><span class="line">    &#125;, <span class="number">0</span>);</span><br><span class="line">&#125;).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">4</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> timer2 = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">5</span>);</span><br><span class="line">&#125;, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">Promise</span>.resolve().then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">6</span>);</span><br><span class="line">&#125;).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">7</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="number">8</span>);</span><br></pre></td></tr></table></figure>

<p><strong>浏览器环境</strong></p>
<p>在浏览器环境上面这段代码在浏览器中的输出结果为：12867345</p>
<p>为什么设定定时器在0s后触发5却晚于7输出？为什么2在Promise里面却紧随着1输出？</p>
<p>在浏览器中EventLoop的执行流程为：</p>
<ol>
<li>检查宏任务队列是否有已完成的宏任务，然后在宏任务队列中取出一个压入执行栈进行执行</li>
<li>检查微任务队列，是否有微任务，如果有则按照<strong>先入先出</strong>的方式一个个进行执行</li>
<li>再次检查微任务队列，看看是否有新入队的微任务，如果有则返回第2步</li>
<li>执行渲染操作，更新界面</li>
<li>检查是否有web worker任务，如果有则进行处理</li>
<li>返回第1步</li>
</ol>
<p>现在来分析上面那段代码的执行流程：</p>
<ol>
<li><p>执行script代码的加载（执行宏任务）</p>
</li>
<li><p>输出1</p>
</li>
<li><p>遇到Promise，Promise接受的回调会同步执行，输出2</p>
</li>
<li><p>遇到定时器timer1，将其添加到宏任务队列</p>
</li>
<li><p>遇到定时器timer2，将其添加到宏任务队列</p>
</li>
<li><p>遇到Promise.then，将其添加到微任务队列</p>
</li>
<li><p>输出8</p>
<p>此时宏任务script代码的加载完成，宏任务队列与微任务队列如下：</p>
<table>
<thead>
<tr>
<th align="left">宏任务</th>
<th align="left">微任务</th>
</tr>
</thead>
<tbody><tr>
<td align="left">timer1的回调</td>
<td align="left">输出6的回调</td>
</tr>
<tr>
<td align="left">timer2的回调</td>
<td align="left"></td>
</tr>
</tbody></table>
</li>
<li><p>清空微任务队列，输出6，并将输出7的回调加入微任务队列</p>
</li>
<li><p>检查是否有新的微任务入队，发现有，输出7</p>
<p>此时微任务队列清空，且没有新的微任务入队，于是执行宏任务</p>
</li>
<li><p>取出到期的定时器timer1的回调，执行，输出3并将输出4的回调加入微任务队列</p>
<p>此时宏任务与微任务队列如下：</p>
<table>
<thead>
<tr>
<th align="left">宏任务</th>
<th align="left">微任务</th>
</tr>
</thead>
<tbody><tr>
<td align="left">timer2的回调</td>
<td align="left">输出4的回调</td>
</tr>
</tbody></table>
</li>
<li><p>清空微任务队列，输出4</p>
<p>此时微任务队列清空，且没有新的微任务入队，于是执行宏任务</p>
</li>
<li><p>输出5</p>
</li>
<li><p>执行完成</p>
</li>
</ol>
<p><strong>node环境</strong></p>
<p>在node环境中分为两种情况：</p>
<ul>
<li>node10及以前的版本输出结果为：12867354</li>
<li>node11及以后的版本输出结果为：12867345</li>
</ul>
<p>为什么会产生差异以及node中的EventLoop是如何实现的？</p>
<p>在node中事件循环分为6个阶段：</p>
<ul>
<li>timer阶段：这个阶段执行timer（setTimeout、setInterval）的回调</li>
<li>I/O callbacks 阶段：这个阶段执行一些系统操作的回调</li>
<li>idle, prepare 阶段：仅node内部使用</li>
<li>poll 阶段：获取新的I/O事件, 适当的条件下node将阻塞在这里</li>
<li>check 阶段：执行 setImmediate() 的回调</li>
<li>close callbacks 阶段：执行 socket 的 close 事件回调</li>
</ul>
<p><strong>poll阶段</strong></p>
<p>poll阶段是非常重要的一个阶段，它主要有两个作用：</p>
<ul>
<li>处理poll队列的事件</li>
<li>有已超时的timer，执行它的回调函数</li>
</ul>
<p>事件循环将同步执行 poll 队列里的回调，直到队列为空或执行的回调达到系统上限。如果没有其他阶段的事要处理，事件循环将会一直阻塞在这个阶段，等待新的 I/O 事件加入 poll 队列中。</p>
<p>如果其他阶段出现了事件：</p>
<ul>
<li>当check队列已经被<code>setImmediate</code>设定了回调，事件循环将结束 poll 阶段往下进入 check 阶段来执行 check 队列</li>
<li>如果 timers 队列有到时的 <code>setTimeout</code> 或者 <code>setInterval</code> 回调，则事件循环将往上绕回 timers 阶段，并执行 timer 队列</li>
</ul>
<p><strong>微任务和宏任务</strong></p>
<p>Node 中只有 <code>process.nextTick</code> 和 <code>Promise callbacks</code> 两个微任务，它们都有各自的队列，<strong>不属于事件循环的一部分</strong>。</p>
<p>不管在什么地方调用，它们总是在各个阶段之间执行，上一阶段完成，进入下一阶段前，会清空 nextTick 和 promsie 队列，并且nextTick 要比 promise callback优先执行。</p>
<p>在node版本差异中，node11及以后的版本一旦执行一个阶段里的一个宏任务就立刻执行微任务队列，跟浏览器端运行一致。</p>
<p>而node10及以前的版本会把所有已到期的定时器执行完再去执行微任务队列。</p>
<p><strong>requestAnimationFrame是宏任务还是微任务？</strong></p>
<p>我们首先要知道浏览器的一帧到底干了什么。</p>
<p>浏览器的每一帧流程为：</p>
<ol>
<li>当<strong>Event loop</strong>执行完微任务后，会判断document是否需要更新</li>
<li>然后判断是否有<strong>resize</strong>或<strong>scroll</strong>，有的话去触发事件</li>
<li>判断是否触发了<strong>media query</strong></li>
<li>更新动画并发送事件</li>
<li>判断是否有全屏操作事件</li>
<li>执行<strong>requestAnimationFrame</strong>回调</li>
<li>执行<strong>IntersectionObserver</strong>回调（该方法用于观测一个元素是否可见）</li>
<li>更新界面</li>
<li>如果一帧中有空闲的时间，就去执行<strong>requestIdleCallback</strong></li>
</ol>
<p>所以<code>requestAnimationFrame</code>既不是宏任务也不是微任务，并且刷新频率也不等于浏览器帧数，通过判断一秒钟内<code>requestAnimationFrame</code>的调用次数可以得知浏览器动画的卡顿情况。</p>
<h2 id="JS异步任务应用"><a href="#JS异步任务应用" class="headerlink" title="JS异步任务应用"></a>JS异步任务应用</h2><p>现在我们对JS中的异步任务有了一定了解，是时候进行应用一下了。</p>
<p>新建一队的异步任务：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sleep</span>(<span class="params">wait</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            resolve(wait);</span><br><span class="line">        &#125;, wait);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> tasks = [];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    tasks.push(<span class="function">() =&gt;</span> sleep(i * <span class="number">1000</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>串行控制</strong></p>
<p>其实这个串行控制有点像webpack的Tapable，如果阅读过webpack源码会很容易理解。</p>
<p>如果要实现串行，并且让上一个异步任务的结果作为下一个的参数，可以使用reduce实现：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> task = tasks.reduce(<span class="function">(<span class="params">pre, current</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> pre.then(<span class="function"><span class="params">res</span> =&gt;</span> current(res));</span><br><span class="line">&#125;, <span class="built_in">Promise</span>.resolve())</span><br><span class="line">task.then(<span class="function"><span class="params">res</span> =&gt;</span> &#123; <span class="built_in">console</span>.log(res); &#125;);</span><br></pre></td></tr></table></figure>

<p>考虑中途是否有任务会添加进来：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SerialAsyncTaskPool</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">tasks, cb</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.tasks = tasks || [];</span><br><span class="line">        <span class="built_in">this</span>.cb = cb;	<span class="comment">// 每个任务执行完成后的回调</span></span><br><span class="line">        <span class="built_in">this</span>.running = <span class="literal">false</span>;</span><br><span class="line">        <span class="built_in">this</span>.preRes;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">pushTask</span>(<span class="params">tasks</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(tasks)) &#123;</span><br><span class="line">            <span class="comment">// 如果不是数组则包装成数组</span></span><br><span class="line">            tasks = [tasks];</span><br><span class="line">        &#125;</span><br><span class="line">        tasks.forEach(<span class="function"><span class="params">task</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.tasks.push(task);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.running) &#123;</span><br><span class="line">            <span class="comment">// 当前任务池不在执行，则让他执行</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">this</span>.preRes !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">            	<span class="built_in">this</span>.run(<span class="built_in">this</span>.preRes);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            	<span class="built_in">this</span>.run();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">run</span>(<span class="params">...args</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.next(resolve, ...args);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">next</span>(<span class="params">resolve, ...args</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.tasks.length) &#123;</span><br><span class="line">            <span class="built_in">this</span>.running = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">const</span> currentTask = <span class="built_in">this</span>.tasks.shift();</span><br><span class="line">            currentTask(...args).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.preRes = res;</span><br><span class="line">                <span class="built_in">this</span>.cb &amp;&amp; <span class="built_in">this</span>.cb(res);</span><br><span class="line">                <span class="built_in">this</span>.next(resolve, res);</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.running = <span class="literal">false</span>;</span><br><span class="line">            resolve(<span class="built_in">this</span>.preRes);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>并行控制</strong></p>
<p>这里考虑两种情况，一种是让运行的任务数量始终维持在一个阙值以下，还有一种是每次从任务池中取出固定数量的任务，当上次取出的任务都完成在取下一次的任务并执行。</p>
<p>让运行的任务数量始终维持在一个阙值以下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ParallelAsyncTaskPool</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">tasks, pool = <span class="number">3</span>, cb</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.tasks = tasks || [];</span><br><span class="line">        <span class="built_in">this</span>.pool = pool;</span><br><span class="line">        <span class="built_in">this</span>.running = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">this</span>.cb = cb;</span><br><span class="line">        <span class="built_in">this</span>.isRunning = <span class="literal">false</span>;</span><br><span class="line">        <span class="built_in">this</span>.resolve;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">pushTask</span>(<span class="params">tasks</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(tasks)) &#123;</span><br><span class="line">            tasks = [tasks];</span><br><span class="line">        &#125;</span><br><span class="line">        tasks.forEach(<span class="function"><span class="params">task</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.tasks.push(task);</span><br><span class="line">            <span class="built_in">this</span>.isRunning &amp;&amp; <span class="built_in">this</span>.next();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">run</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.resolve = resolve;</span><br><span class="line">            <span class="built_in">this</span>.isRunning = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="built_in">this</span>.tasks.length; i++) &#123;</span><br><span class="line">                <span class="built_in">this</span>.next();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">next</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.tasks.length &amp;&amp; <span class="built_in">this</span>.running &lt; <span class="built_in">this</span>.pool) &#123;</span><br><span class="line">            <span class="built_in">this</span>.running++;</span><br><span class="line">            <span class="keyword">const</span> currentTask = <span class="built_in">this</span>.tasks.shift();</span><br><span class="line">            currentTask().then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.cb &amp;&amp; <span class="built_in">this</span>.cb(res);</span><br><span class="line">                <span class="built_in">console</span>.log(res);</span><br><span class="line">                <span class="built_in">this</span>.running--;</span><br><span class="line">                <span class="built_in">this</span>.next();</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">this</span>.tasks.length &amp;&amp; !<span class="built_in">this</span>.running) &#123;</span><br><span class="line">            <span class="built_in">this</span>.isRuning = <span class="literal">false</span>;</span><br><span class="line">            <span class="built_in">this</span>.resolve()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>批量并行：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ParallelGroupAsyncTaskPool</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">tasks, pool = <span class="number">3</span>, cb</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.tasks = tasks || [];</span><br><span class="line">        <span class="built_in">this</span>.pool = pool;</span><br><span class="line">        <span class="built_in">this</span>.cb = cb;</span><br><span class="line">        <span class="built_in">this</span>.complete = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">pushTask</span>(<span class="params">tasks</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(tasks)) &#123;</span><br><span class="line">            tasks = [tasks];</span><br><span class="line">        &#125;</span><br><span class="line">        tasks.forEach(<span class="function"><span class="params">task</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.tasks.push(task);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">run</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.next(resolve);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">next</span>(<span class="params">resolve</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.tasks.length &amp;&amp; !<span class="built_in">this</span>.runing) &#123;</span><br><span class="line">            <span class="keyword">const</span> runingTasks = <span class="built_in">this</span>.tasks.splice(<span class="number">0</span>, <span class="built_in">this</span>.pool);</span><br><span class="line">            <span class="built_in">Promise</span>.all(runingTasks.map(<span class="function"><span class="params">task</span> =&gt;</span> task())).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.cb &amp;&amp; <span class="built_in">this</span>.cb();</span><br><span class="line">                <span class="built_in">this</span>.next(resolve);</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">this</span>.tasks.length) &#123;</span><br><span class="line">            resolve();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://fallcoin.github.io/2021/04/15/%E6%96%90%E6%B3%A2%E9%82%A3%E5%A5%91%E6%95%B0%E5%88%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fallcoin's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/04/15/%E6%96%90%E6%B3%A2%E9%82%A3%E5%A5%91%E6%95%B0%E5%88%97/" itemprop="url">斐波那契数列</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-04-15T22:06:30+08:00">
                2021-04-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="斐波那契数列"><a href="#斐波那契数列" class="headerlink" title="斐波那契数列"></a>斐波那契数列</h2><p>斐波那契数列，也叫兔子数列，规律为下一个数是前两个数字的和，如：0，1，1，2，3，5。通常题型为计算第n项的值。</p>
<h3 id="计算方式"><a href="#计算方式" class="headerlink" title="计算方式"></a>计算方式</h3><ul>
<li><p>递归实现</p>
<ul>
<li>优点：代码简洁易懂</li>
<li>缺点：重复计算某些值，递归嵌套过深</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fibonacci1</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (n === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (n === <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fibonacci1(n - <span class="number">1</span>) + fibonacci1(n - <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>闭包 + 数组进行缓存</p>
<ul>
<li>优点：无需重复计算</li>
<li>缺点：需要额外的数组空间</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fibonacci2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> memo = [<span class="number">0</span>, <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">const</span> fib = <span class="function"><span class="keyword">function</span> (<span class="params">n</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (memo[n] === <span class="literal">undefined</span>) &#123;</span><br><span class="line">            memo[n] = fib(n - <span class="number">1</span>) + fib(n - <span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> memo[n];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fib;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>尾递归</p>
<p>所谓尾递归，指的是在函数执行的最后一句调用自身函数，由于函数执行完自身的上下文环境也会出栈，所以尾递归函数执行的函数栈始终为一层。</p>
<ul>
<li>优点：函数调用栈始终为一层</li>
<li>缺点：堆栈信息丢失，调试较为困难</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fibonacci3</span>(<span class="params">n, ac1 = <span class="number">0</span>, ac2 = <span class="number">1</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (n === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ac1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (n === <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ac2;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fibonacci3(n - <span class="number">1</span>, ac2, ac1 + ac2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://fallcoin.github.io/2021/04/14/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fallcoin's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/04/14/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" itemprop="url">性能优化</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-04-14T22:01:13+08:00">
                2021-04-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="防抖和节流"><a href="#防抖和节流" class="headerlink" title="防抖和节流"></a>防抖和节流</h2><h3 id="什么是防抖和节流"><a href="#什么是防抖和节流" class="headerlink" title="什么是防抖和节流"></a>什么是防抖和节流</h3><ul>
<li><strong>防抖</strong>：所谓防抖，就是指触发事件后在 n 秒内函数只能执行一次，如果在 n 秒内又触发了事件，则会重新计算函数执行时间</li>
<li><strong>节流</strong>：所谓节流，就是指连续触发事件但是在 n 秒中只执行一次函数</li>
</ul>
<h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><ul>
<li>防抖<ul>
<li>浏览器窗口调整时</li>
<li>文本编辑器保留时</li>
<li>登录、发短信等按钮避免用户点击太快，以致于发送了多次请求</li>
</ul>
</li>
<li>节流<ul>
<li>input框显示提示输入词时需要节流</li>
<li>scroll事件</li>
</ul>
</li>
</ul>
<h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><ul>
<li><p>防抖</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">debounce</span>(<span class="params">func, wait</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> timeout;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> context = <span class="built_in">this</span>;	<span class="comment">// 保存this指向</span></span><br><span class="line">        <span class="keyword">let</span> args = <span class="built_in">arguments</span>;	<span class="comment">// 获取参数</span></span><br><span class="line">        <span class="keyword">if</span> (timeout) &#123;</span><br><span class="line">            <span class="comment">// 在n秒内重新触发了事件，清空定时器</span></span><br><span class="line">            <span class="built_in">clearTimeout</span>(timeout);</span><br><span class="line">        &#125;</span><br><span class="line">        timeout = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            func.apply(context, args)</span><br><span class="line">        &#125;, wait);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>节流</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">throttle</span>(<span class="params">func, wait</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> previous = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> now = <span class="built_in">Date</span>.now();</span><br><span class="line">        <span class="keyword">let</span> context = <span class="built_in">this</span>;	<span class="comment">// 保存this指向</span></span><br><span class="line">        <span class="keyword">let</span> args = <span class="built_in">arguments</span>;	<span class="comment">// 获取参数</span></span><br><span class="line">        <span class="keyword">if</span> (now - previous &gt; wait) &#123;</span><br><span class="line">            func.apply(context, args);</span><br><span class="line">            previous = now;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://fallcoin.github.io/2021/04/14/call-apply%E5%92%8Cbind%E7%9A%84%E7%94%A8%E6%B3%95%E4%B8%8E%E5%8C%BA%E5%88%AB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fallcoin's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/04/14/call-apply%E5%92%8Cbind%E7%9A%84%E7%94%A8%E6%B3%95%E4%B8%8E%E5%8C%BA%E5%88%AB/" itemprop="url">call,apply和bind的用法与区别</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-04-14T21:46:40+08:00">
                2021-04-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="call-apply和bind的用法与区别"><a href="#call-apply和bind的用法与区别" class="headerlink" title="call,apply和bind的用法与区别"></a>call,apply和bind的用法与区别</h2><p><code>call</code>，<code>apply</code>，<code>bind</code>是用来改变函数执行时的上下文，也就是<strong>改变this的指向</strong>。</p>
<h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><ul>
<li>比如当我们想让类数组（<code>arguments</code>，<code>nodeList</code>）使用数组的方法（<code>map</code>，<code>forEach</code>等），就需要为它绑定新的上下文，因为类数组身上没有数组的方法。</li>
<li>保存this的指向，如react中保存回调函数的this。</li>
</ul>
<h3 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h3><ul>
<li>call第一个参数接收新的上下文指向对象，剩下的参数为函数接收的参数，返回函数调用后的结果。</li>
<li>apply第一个参数接收新的上下文指向对象，第二个参数为一个数组，里面维护函数所接收的参数，返回函数调用后的结果。</li>
<li>bind第一个参数接收新的上下文指向对象，剩下的参数为函数接收的参数，返回上下文指向改变后的新的函数。</li>
</ul>
<h3 id="手写call，apply和bind"><a href="#手写call，apply和bind" class="headerlink" title="手写call，apply和bind"></a>手写call，apply和bind</h3><h4 id="call"><a href="#call" class="headerlink" title="call"></a>call</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// call</span></span><br><span class="line"><span class="built_in">Function</span>.prototype.mycall = <span class="function"><span class="keyword">function</span> (<span class="params">context = <span class="built_in">window</span>, ...args</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> fn = <span class="built_in">Symbol</span>(<span class="string">&#x27;fn&#x27;</span>);	<span class="comment">// 防止属性重复</span></span><br><span class="line">    context[fn] = <span class="built_in">this</span>;</span><br><span class="line">    <span class="keyword">const</span> result = context[fn](...args);</span><br><span class="line">    <span class="keyword">delete</span> context[fn];	<span class="comment">// 删除上下文中的该属性</span></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="apply"><a href="#apply" class="headerlink" title="apply"></a>apply</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// apply</span></span><br><span class="line"><span class="built_in">Function</span>.prototype.myapply = <span class="function"><span class="keyword">function</span> (<span class="params">context = <span class="built_in">window</span>, args</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> fn = <span class="built_in">Symbol</span>(<span class="string">&#x27;fn&#x27;</span>);	<span class="comment">// 防止属性重复</span></span><br><span class="line">    context[fn] = <span class="built_in">this</span>;</span><br><span class="line">    <span class="keyword">const</span> result = context[fn](...args);</span><br><span class="line">    <span class="keyword">delete</span> context[fn];	<span class="comment">// 删除上下文中的该属性</span></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="bind"><a href="#bind" class="headerlink" title="bind"></a>bind</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bind</span></span><br><span class="line"><span class="built_in">Function</span>.prototype.myBind = <span class="function"><span class="keyword">function</span> (<span class="params">context, ...params</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> fn = <span class="built_in">this</span>;</span><br><span class="line">    <span class="keyword">const</span> newFn = <span class="function"><span class="keyword">function</span> (<span class="params">...args</span>) </span>&#123;  <span class="comment">// 调用bind返回新函数</span></span><br><span class="line">        <span class="keyword">const</span> that = (<span class="built_in">this</span> <span class="keyword">instanceof</span> newFn) ? <span class="built_in">this</span> : context;  <span class="comment">// 新函数是否被new调用，是的话this指向自身</span></span><br><span class="line">        <span class="keyword">return</span> fn.call(that, ...params, ...args);</span><br><span class="line">    &#125;;</span><br><span class="line">    newFn.prototype = <span class="built_in">Object</span>.create(fn.prototype);  <span class="comment">// 继承原函数原型链</span></span><br><span class="line">    <span class="keyword">return</span> newFn;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7Carchive">
              
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Fallcoin</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
